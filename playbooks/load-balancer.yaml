
---
- name: Install HAProxy and make kube-apiserver highly available
  hosts: bastion
  tasks:
    - name: Install HAProxy
      apt:
        name: haproxy
        state: present
      become: true
    - name: Create HAProxy user and group
      user:
        name: haproxy
        group: haproxy
        shell: /bin/false
        system: yes
      become: true
    - name: Copy HAProxy configuration
      template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
      become: true
    - name: Restart HAProxy
      service:
        name: haproxy
        state: restarted
      become: true